<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Espace agent - Al Baraka Digital</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
               background: #020617; margin: 0; min-height: 100vh; color: #e5e7eb;
               display: flex; justify-content: center; padding: 40px 16px; }
        .layout { max-width: 1150px; width: 100%; display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px; }
        .card { background: #020617; border-radius: 12px; padding: 20px 24px;
                box-shadow: 0 18px 40px rgba(15,23,42,0.8); border: 1px solid #1f2937; }
        .card-header { display:flex; justify-content:space-between; align-items:baseline; margin-bottom:12px; }
        .card-title { font-size:1.1rem; font-weight:600; }
        .card-subtitle { font-size:0.8rem; color:#9ca3af; }
        .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; font-size:0.85rem; }
        .brand { font-size:0.9rem; color:#38bdf8; font-weight:600; }
        .logout-link a { color:#9ca3af; text-decoration:none; font-size:0.8rem; }
        .logout-link a:hover { color:#e5e7eb; }
        .small { font-size:0.75rem; color:#6b7280; }
        table { width:100%; border-collapse:collapse; font-size:0.85rem; }
        th,td { padding:8px 6px; border-bottom:1px solid #111827; }
        th { text-align:left; color:#9ca3af; font-weight:500; }
        tr:hover { background:rgba(30,64,175,0.2); cursor:pointer; }
        .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:0.7rem; }
        .badge-pending { background:rgba(250,204,21,0.12); color:#facc15; }
        .badge-ai { background:rgba(56,189,248,0.12); color:#38bdf8; }
        .detail-field { font-size:0.85rem; margin-bottom:6px; }
        .detail-label { color:#9ca3af; margin-right:4px; }
        .btn-primary, .btn-danger {
            border-radius:999px; padding:6px 12px; font-size:0.8rem; font-weight:600; border:none; cursor:pointer;
        }
        .btn-primary { background:linear-gradient(135deg,#34d399,#10b981); color:white; }
        .btn-danger { background:linear-gradient(135deg,#f97373,#ef4444); color:white; }
        .btn-primary:hover, .btn-danger:hover { opacity:0.95; }
        .muted { color:#6b7280; font-size:0.8rem; }
    </style>
</head>
<body>
<div class="layout">

    <!-- Liste PENDING -->
    <div class="card">
        <div class="top-bar">
            <div>
                <div class="brand">Al Baraka Digital</div>
                <div class="small">Espace agent bancaire</div>
            </div>
            <div class="logout-link">
                <form th:action="@{/logout}" method="post" style="display:inline;">
                    <button type="submit"
                            style="background:none;border:none;color:#9ca3af;font-size:0.8rem;cursor:pointer;">
                        Se déconnecter
                    </button>
                </form>
            </div>
        </div>

        <div class="card-header">
            <div class="card-title">Opérations en attente</div>
            <div class="card-subtitle">Statut PENDING &gt; 10 000 DH</div>
        </div>

        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Client</th>
                <th>Type</th>
                <th>Montant</th>
                <th>IA</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            <!-- Liste PENDING dynamique -->
            <tr th:each="op : ${pendingPage.content}">
                <td th:text="${op.id}">12</td>
                <td th:text="${op.accountSource != null && op.accountSource.owner != null ? op.accountSource.owner.fullName : 'N/A'}">
                    Client
                </td>
                <td th:text="${op.type}">TRANSFER</td>
                <td th:text="${#numbers.formatDecimal(op.amount, 1, 'COMMA', 2, 'POINT')} + ' DH'">15000 DH</td>
                <td>
                    <span class="badge badge-ai"
                          th:text="${op.aiDecision != null ? op.aiDecision : 'PENDING_IA'}">
                        NEED_HUMAN_REVIEW
                    </span>
                </td>
                <td>
                    <!-- Lien pour charger le détail dans la colonne de droite -->
                    <a th:href="@{/agent/home(selectedId=${op.id})}" class="muted">Détail</a>
                </td>
            </tr>
            <tr th:if="${pendingPage.content.empty}">
                <td colspan="6" class="muted">Aucune opération en attente.</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Détail + actions -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">Détail de l'opération</div>
            <div class="card-subtitle">Recommandation IA vs décision agent</div>
        </div>

        <div th:if="${selectedOperation != null}">
            <div class="detail-field">
                <span class="detail-label">ID :</span>
                <span th:text="${selectedOperation.id}">12</span>
            </div>
            <div class="detail-field">
                <span class="detail-label">Client :</span>
                <span th:text="${selectedOperation.accountSource != null && selectedOperation.accountSource.owner != null ? selectedOperation.accountSource.owner.fullName : 'N/A'}">
                    sharifa nbigui
                </span>
            </div>
            <div class="detail-field">
                <span class="detail-label">Type :</span>
                <span th:text="${selectedOperation.type}">TRANSFER</span>
            </div>
            <div class="detail-field">
                <span class="detail-label">Montant :</span>
                <span th:text="${#numbers.formatDecimal(selectedOperation.amount, 1, 'COMMA', 2, 'POINT')} + ' DH'">
                    15000 DH
                </span>
            </div>
            <div class="detail-field">
                <span class="detail-label">Recommandation IA :</span>
                <span class="badge badge-ai"
                      th:text="${selectedOperation.aiDecision != null ? selectedOperation.aiDecision : 'AUCUNE'}">
                    NEED_HUMAN_REVIEW
                </span>
            </div>
            <div class="detail-field">
                <span class="detail-label">Commentaire IA :</span>
                <span class="small"
                      th:text="${selectedOperation.aiComment != null ? selectedOperation.aiComment : 'Pas de commentaire IA.'}">
                    Montant élevé, revue humaine recommandée.
                </span>
            </div>

            <div style="margin-top:16px; display:flex; gap:8px;">
                <form th:action="@{'/agent/operations/' + ${selectedOperation.id} + '/approve'}" method="post">
                    <button type="submit" class="btn-primary">Approuver</button>
                </form>
                <form th:action="@{'/agent/operations/' + ${selectedOperation.id} + '/reject'}" method="post">
                    <button type="submit" class="btn-danger">Rejeter</button>
                </form>
            </div>

            <div class="small" style="margin-top:10px;">
                La décision finale est toujours celle de l’agent, l’IA fournit une recommandation.
            </div>
        </div>

        <div th:if="${selectedOperation == null}" class="muted">
            Sélectionnez une opération dans la liste pour voir le détail et prendre une décision.
        </div>
    </div>

</div>
</body>
</html>